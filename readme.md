# m3u8 è§†é¢‘æå–å·¥å…·ï¼ˆä¸‹è½½webä¸­çš„tsæ–‡ä»¶ï¼‰

### å¼€å‘èƒŒæ™¯

- m3u8è§†é¢‘æ ¼å¼ç®€ä»‹ï¼ˆå€Ÿç”¨ä»–äººæè¿°ï¼‰
  - m3u8è§†é¢‘æ ¼å¼åŸç†ï¼šå°†å®Œæ•´çš„è§†é¢‘æ‹†åˆ†æˆå¤šä¸ª .ts è§†é¢‘ç¢ç‰‡ï¼Œ.m3u8 æ–‡ä»¶è¯¦ç»†è®°å½•æ¯ä¸ªè§†é¢‘ç‰‡æ®µçš„åœ°å€ã€‚
  - è§†é¢‘æ’­æ”¾æ—¶ï¼Œä¼šå…ˆè¯»å– .m3u8 æ–‡ä»¶ï¼Œå†é€ä¸ªä¸‹è½½æ’­æ”¾ .ts è§†é¢‘ç‰‡æ®µã€‚
  - å¸¸ç”¨äºç›´æ’­ä¸šåŠ¡ï¼Œä¹Ÿå¸¸ç”¨è¯¥æ–¹æ³•è§„é¿è§†é¢‘çªƒå–çš„é£é™©ã€‚åŠ å¤§è§†é¢‘çªƒå–éš¾åº¦ã€‚
- é‰´äº m3u8 ä»¥ä¸Šç‰¹ç‚¹ï¼Œæ— æ³•ç®€å•é€šè¿‡è§†é¢‘é“¾æ¥ä¸‹è½½ï¼Œéœ€ä½¿ç”¨ç‰¹å®šä¸‹è½½è½¯ä»¶ã€‚ï¼ˆå€Ÿç”¨ä»–äººæè¿°ï¼‰
  - ä½†è½¯ä»¶ä¸‹è½½è¿‡ç¨‹ç¹çï¼Œè¯•é”™æˆæœ¬é«˜ã€‚
  - ä½¿ç”¨è½¯ä»¶çš„ä¸‹è½½æƒ…å†µä¸ç¨³å®šï¼Œå¸¸å‡ºç°æµè§ˆå™¨æ­£å¸¸æ’­æ”¾ï¼Œä½†è½¯ä»¶ä¸‹è½½é€Ÿåº¦æ…¢ï¼Œç”šè‡³æ— æ³•æ­£å¸¸ä¸‹è½½çš„æƒ…å†µã€‚
  - è½¯ä»¶è¢«ç¼–è¯‘æ‰“åŒ…ï¼Œæ— æ³•äº†è§£å†…éƒ¨è¿è¡Œæœºåˆ¶ï¼Œä¸æ¸…æ¥šé‡Œé¢åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚

- æœç´¢ç½‘ä¸Šå¹¶ä¸èƒ½å®Œå…¨ç¬¦åˆæˆ‘çš„åŠŸèƒ½ï¼Œæœ‰æ—¶éœ€è¦è§£å¯†å¯¹åº”M3U8è§†é¢‘æ–‡ä»¶çš„C#ä»£ç  ï¼Œå›ºå†™äº†å¯¹åº”çš„C#ç®€æ˜“ä»£ç ã€‚

### å·¥å…·ç‰¹ç‚¹

* åˆ©ç”¨C# è¯­è¨€å¼€å‘ ç±»åº“çš„æ–¹å¼æ”¯æŒè°ƒç”¨
* å‚æ•°ç®€å• åªéœ€è¦æä¾›å¯¹åº”çš„ M3u8æ–‡ä»¶ä¸‹è½½åœ°å€ å’Œå¯¹åº”æ–‡ä»¶çš„å­˜æ”¾è·¯å¾„å°±ä¼šè‡ªåŠ¨ä¸‹è½½
* æ”¯æŒå•å’Œå¤šçº¿ç¨‹çš„è‡ªä¸»é€‰æ‹© åŒæ—¶ä¼šå¯¹ä¸‹è½½å¤±è´¥çš„æ–‡ä»¶è‡ªåŠ¨é‡æ–°ä¸‹è½½ä¸€æ¬¡

### åŠŸèƒ½è¯´æ˜

â€‹	è¾“å…¥å¯¹åº”M3U8æ–‡ä»¶çš„ä¸‹è½½åœ°å€å’Œä¿å­˜çš„æ–‡ä»¶å¤¹è·¯å¾„ï¼Œå°±ä¼šå¼€å§‹ä¸‹è½½

### ä½¿ç”¨è¯´æ˜

å¼€å‘è€…å¯åˆ©ç”¨ç›¸å…³ä»£ç æˆ–æ‰‹å·¥è·å–åˆ°å¯¹åº”çš„M3U8ğŸ“ƒçš„ä¸‹è½½åœ°å€ï¼Œåˆ›å»ºTsHelperå¯¹è±¡ï¼Œè°ƒç”¨ReuqestAndSaveï¼ˆï¼‰æ–¹æ³•ã€‚å³å¯å®Œæˆä¸‹è½½ã€‚ä¸‹è½½çš„æ—¥å¿—å¯ä»¥é€šè¿‡æ‰“å¼€DebugViewæŸ¥çœ‹ã€‚

```c#
TsHelper tsHelper = new TsHelper(url,@"C:\temp\å­˜æ”¾æ‰€æœ‰è§†é¢‘çš„baseæ–‡ä»¶å¤¹","æˆ‘çš„æµ‹è¯•è§†é¢‘1æ–‡ä»¶å¤¹");
bool flag = tsHelper.ReuqestAndSave();
```

### å®ç°æ€è·¯

â¬ä¸‹è½½è§£æM3U8æ–‡ä»¶ï¼š

1.é¦–å…ˆé€šè¿‡ç»™å®šurlè¯·æ±‚å¯¹åº”çš„m3u8æ–‡ä»¶-->ç»“æœå†™å…¥M3U8Responseã€‚

2.è¯·æ±‚åçš„ç»“æœå¯èƒ½ä¼šå¾—åˆ°å¤šç ç‡çš„m3u8æ–‡ä»¶çš„æ–°çš„æŒ‡å‘ï¼Œè¿™é‡Œé»˜è®¤è¯·æ±‚ç¬¬ä¸€ä¸ªç ç‡çš„urlï¼Œç„¶åè¯·æ±‚ç»“æœè¦†ç›–M3U8Responseã€‚

3.å¯¹è¯·æ±‚çš„ç»“æœM3U8Responseè¿›è¡Œè§£æï¼š

> 3.1 æœ‰ASE-128 åŠ å¯† --ã€‹è¯·æ±‚åŠ å¯†çš„Keyæ–‡ä»¶è·å–å¯†é’¥
>
> 3.2æ— åŠ å¯† 

4.ç„¶åè¯·æ±‚m3u8æ–‡ä»¶ç»™å‡ºçš„æ‰€æœ‰çš„tsæ–‡ä»¶ï¼Œä¸‹è½½ç»“æŸååˆ¤è¯»åŠ å¯†ğŸ”ï¼Œå¦‚æœæœ‰åŠ å¯†å°±é€šè¿‡DealTS()è¿™ä¸ªå‡½æ•°ï¼Œå¯¹ä¸‹è½½çš„å­—èŠ‚æµè§£ç ã€‚

5.ä¿å­˜æ‰€æœ‰çš„tsæ–‡ä»¶ï¼Œæœ€åç”Ÿæˆä¸€ä¸ªæ–°çš„m3u8æ–‡ä»¶åœ¨tsçš„ç›®å½•ä¸‹é¢åä¸ºï¼š\__main__.m3u8

### æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

```csharp
/// <summary>
/// è¯·æ±‚m3u8åœ°å€
/// </summary>
private void RequestM3U8()
{
	M3U8Response = RequestM3U8(this.M3U8Url);
}

/// <summary>
/// è§£æm3u8 å¹¶ä¿å­˜æˆè‡ªå·±çš„
/// </summary>
private void AnalysisM3U8()
{
  //åˆ¤æ–­æ˜¯å¦  å¤šç ç‡é€‚é…æµ å¹¶é‡æ–°è¯·æ±‚
  IsMutiple();

  //å¦‚æœéœ€è¦è‡ªå·±é‡æ–°åŠ å¯†çš„ é‚£ä¹ˆéœ€è¦ç”Ÿæˆå¯¹åº”çš„key
  if (outFileConfig.saveAsEncrpy) GenerateAESKey();

  Logger.LogDebug("åˆ†è§£å‡ºæ‰€æœ‰çš„tsæ–‡ä»¶" + M3U8Response);
  //åˆ†è§£å‡ºæ‰€æœ‰çš„tsæ–‡ä»¶
  SpliteM3U8(M3U8Response);

  //æ£€æµ‹è§†é¢‘ AES åŠ å¯†
  if (M3U8Response.IndexOf("#EXT-X-KEY") != -1)
  {
    //.*METHOD=([^,]+) #EXT-X-KEY:METHOD=AES-128,
    var method = ReGeXHelper.GetRes(M3U8Response, @".*METHOD=([^,]+)");
    aesConf.method = method != null ? method.Groups[1].Value : "";

    //.*URI="([^"]+)  URI="key.key" 
    var uri = ReGeXHelper.GetRes(M3U8Response, @".*URI=""([^""]+)");
    aesConf.uri = uri != null ? uri.Groups[1].Value : "";

    //.*IV=([^,]+) 
    var iv = ReGeXHelper.GetRes(M3U8Response, @".*IV=([^,]+)");
    aesConf.iv = iv != null ? iv.Groups[1].Value : "";

    aesConf.uri = ApplyURL(aesConf.uri, M3U8Url);

    Logger.LogDebug("è§£å¯†" + aesConf.uri);
    GetAES();
  }
  else
  {
    DownloadTS();
  }
  Logger.LogDebug("ä¿å­˜æ–°çš„m3u8");
  OutSaveEnd();
}
```

ä¸€ä¸ªæ˜¯è¯·æ±‚m3u8æ–‡ä»¶çš„å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯åˆ†æè¯·æ±‚åçš„å“åº”å‡½æ•°

#### Endï¼š

* å¯èƒ½ä»£ç ä¸è§„èŒƒï¼Œå†™çš„å¤æ‚ï¼Œä¸æ˜“ç†è§£ã€‚å„ä½å­¦é•¿å­¦å§è®²æ­¦å¾·å•Šã€‚



